
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tutorial: Coherent Point Drift (CPD) Algorithm for Point Set Registration &#8212; Comprehensive Examination</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorial';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Parth Ganeriwala Comprehensive Breadth Examination" href="intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Comprehensive Examination</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Parth Ganeriwala Comprehensive Breadth Examination
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Tutorial: Coherent Point Drift (CPD) Algorithm for Point Set Registration</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ParthGaneriwala/PointSetRegistration" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ParthGaneriwala/PointSetRegistration/issues/new?title=Issue%20on%20page%20%2Ftutorial.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/tutorial.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tutorial: Coherent Point Drift (CPD) Algorithm for Point Set Registration</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#point-set-registration">Point Set Registration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-closest-point-icp-algorithm">Iterative Closest Point (ICP) Algorithm</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coherent-point-drift-cpd-algorithm">Coherent Point Drift (CPD) Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#algorithm-overview">Algorithm Overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#expectation-step">Expectation Step</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#maximization-step">Maximization Step</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#point-cloud-registration-with-cpd-example-code">Point Cloud Registration with CPD Example Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#https-siavashk-github-io-2017-05-14-coherent-point-drift">(https://siavashk.github.io/2017/05/14/coherent-point-drift/)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-correspondences">Missing Correspondences</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-mixture-models">Gaussian Mixture Models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gmm-based-registration">GMM-based Registration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Expectation Step</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Maximization Step</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#icp-algorithm">ICP Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-coherent-point-drift-cpd-and-iterative-closest-point-icp-algorithms-provides-insights-into-their-respective-strengths-and-weaknesses-in-point-cloud-registration-tasks-cpd-a-probabilistic-framework-excels-in-scenarios-where-point-correspondences-are-ambiguous-or-partial-thanks-to-its-ability-to-model-soft-correspondences-and-account-for-noise-and-outliers-effectively-it-can-handle-non-rigid-transformations-and-deformations-making-it-suitable-for-tasks-involving-complex-shapes-or-objects-undergoing-morphological-changes-however-cpd-may-suffer-from-increased-computational-complexity-especially-with-large-datasets-and-requires-careful-parameter-tuning-for-optimal-performance-on-the-other-hand-icp-is-a-simpler-and-computationally-efficient-method-ideal-for-rigid-transformations-and-scenarios-with-well-defined-point-correspondences-it-converges-quickly-and-is-robust-to-noise-making-it-suitable-for-real-time-applications-or-situations-where-computational-resources-are-limited-nevertheless-icp-s-rigid-assumption-limits-its-applicability-to-non-rigid-transformations-or-scenarios-with-significant-shape-variations-in-summary-while-cpd-offers-versatility-and-robustness-for-challenging-registration-tasks-icp-provides-simplicity-and-efficiency-for-more-straightforward-alignment-problems-the-choice-between-cpd-and-icp-depends-on-the-specific-requirements-of-the-registration-task-including-the-nature-of-the-point-clouds-the-presence-of-noise-or-outliers-and-the-desired-level-of-computational-complexity">Comparing Coherent Point Drift (CPD) and Iterative Closest Point (ICP) algorithms provides insights into their respective strengths and weaknesses in point cloud registration tasks. CPD, a probabilistic framework, excels in scenarios where point correspondences are ambiguous or partial, thanks to its ability to model soft correspondences and account for noise and outliers effectively. It can handle non-rigid transformations and deformations, making it suitable for tasks involving complex shapes or objects undergoing morphological changes. However, CPD may suffer from increased computational complexity, especially with large datasets, and requires careful parameter tuning for optimal performance. On the other hand, ICP is a simpler and computationally efficient method, ideal for rigid transformations and scenarios with well-defined point correspondences. It converges quickly and is robust to noise, making it suitable for real-time applications or situations where computational resources are limited. Nevertheless, ICP’s rigid assumption limits its applicability to non-rigid transformations or scenarios with significant shape variations. In summary, while CPD offers versatility and robustness for challenging registration tasks, ICP provides simplicity and efficiency for more straightforward alignment problems. The choice between CPD and ICP depends on the specific requirements of the registration task, including the nature of the point clouds, the presence of noise or outliers, and the desired level of computational complexity.</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="tutorial-coherent-point-drift-cpd-algorithm-for-point-set-registration">
<h1>Tutorial: Coherent Point Drift (CPD) Algorithm for Point Set Registration<a class="headerlink" href="#tutorial-coherent-point-drift-cpd-algorithm-for-point-set-registration" title="Link to this heading">#</a></h1>
<p>In this tutorial, we will explore the Coherent Point Drift (CPD) algorithm for point set registration. We will go through the background, examples and sample experiments. We will also be looking into the comparison of Coherent Point Drift Algorithm with the standard ICP algorithm for point set registration. Let’s start by defining what point set registration is.</p>
<p>Point set registration is a crucial task in computer vision and robotics, involving aligning two or more sets of points from different sources or time instances to find their spatial correspondence. This alignment is fundamental for various applications like 3D reconstruction, object recognition, and medical image analysis. Iterative Closest Point (ICP)
 and Coherent Point Drift (CPD)  are two prominent algorithms in point set registration. ICP iteratively minimizes the distances between corresponding points in the sets, refining the transformation until convergence. CPD, on the other hand, models the transformation as a probability distribution over the point sets, enabling robust registration even in the presence of outliers and noise. While ICP is efficient for rigid registration, CPD extends to non-rigid transformations, offering versatility in aligning deformable structures like biological tissues or articulated objects. Together, these algorithms constitute powerful tools for accurately aligning point sets across various domains.</p>
<p>ICP works by pairing each point in the ‘source’ point cloud (the one which is to be transformed) with the nearest point in the ‘reference’ point cloud (points in the reference cloud can be paired to more than one source cloud point), then estimating the transformation that will most reduce the mean square of the distances between pairs. The points are then re-paired; the process is repeated until the stopping conditions are met.</p>
<p>Coherent point drift (CPD) treats registration as a probability density estimation problem, in which one point cloud is treated as the probability distribution of the centroids of a Gaussian mixture model, and the other as data points drawn from the distribution; registration is then performed by finding the position at which the probability of the data points being observed is maximised. Motion coherence of the centroids is imposed to preserve topological structure. Myronenko and Song (2010) tested CPD on example point clouds and showed it to be more accurate and robust to noise and outliers than ICP.</p>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Before we dive into the details of CPD, let’s briefly discuss the problem of point set registration and the Iterative Closest Point (ICP) algorithm, which is one of the most widely used methods for point set registration.</p>
<section id="point-set-registration">
<h3>Point Set Registration<a class="headerlink" href="#point-set-registration" title="Link to this heading">#</a></h3>
<p>Given two sets of points (<span class="math notranslate nohighlight">\(X = {x_1, x_2, ..., x_N}\)</span>) and (<span class="math notranslate nohighlight">\(Y = {y_1, y_2, ..., y_M}\)</span>), the goal of point set registration is to find a transformation (T) such that when applied to (X), the transformed points are aligned as closely as possible to (Y).</p>
</section>
<section id="iterative-closest-point-icp-algorithm">
<h3>Iterative Closest Point (ICP) Algorithm<a class="headerlink" href="#iterative-closest-point-icp-algorithm" title="Link to this heading">#</a></h3>
<p>ICP is an iterative optimization algorithm commonly used for point set registration. It alternates between two steps:</p>
<ol class="arabic simple">
<li><p><strong>Correspondence Estimation</strong>: Given the current transformation (T), find the correspondence between points in (X) and (Y).</p></li>
<li><p><strong>Transformation Estimation</strong>: Given the correspondence, estimate the transformation (T) that aligns (X) with (Y).</p></li>
</ol>
<p>ICP repeats these steps until convergence.</p>
<p>While ICP is effective, it can be sensitive to noise and outliers, and it may converge to local minima. CPD, on the other hand, addresses some of these limitations by incorporating coherence information and introducing soft correspondences.</p>
</section>
</section>
<section id="coherent-point-drift-cpd-algorithm">
<h2>Coherent Point Drift (CPD) Algorithm<a class="headerlink" href="#coherent-point-drift-cpd-algorithm" title="Link to this heading">#</a></h2>
<p>The Coherent Point Drift (CPD) algorithm, introduced by Andriy Myronenko and Xubo Song in their paper “Point Set Registration: Coherent Point Drift” (2009) , is a powerful method for point set registration. CPD extends traditional point set registration methods by introducing a probabilistic framework that models the point set correspondences as a Gaussian Mixture Model (GMM). This allows CPD to handle noise, outliers, and partial overlap between point sets more effectively than traditional methods like ICP.</p>
<section id="algorithm-overview">
<h3>Algorithm Overview<a class="headerlink" href="#algorithm-overview" title="Link to this heading">#</a></h3>
<p>The CPD algorithm can be summarized in the following steps:</p>
<ol class="arabic simple">
<li><p><strong>Initialization</strong>: Initialize the transformation (T) and the parameters such as translation, rotation, and scaling, which define the initial alignment between the two point sets. We also estimate the covariance matrix and the scaling factor for the Gaussian Mixture Model (GMM) that represents the probability distribution of the transformation.</p></li>
<li><p><strong>Expectation Step</strong>: Compute the expected correspondence probabilities between points in (X) and (Y) point sets using the GMM and the current transformation parameters and update the weights and means of the GMM based on the current correspondences.</p></li>
<li><p><strong>Maximization Step</strong>: Update the transformation parameters to maximize the likelihood of the correspondences of the transformation (T). This involves updating the translation, rotation, scaling, and the parameters of the GMM (mean, covariance, and mixture coefficients).</p></li>
<li><p><strong>Iteration</strong>: Check whether the algorithm has converged by comparing the change in transformation parameters between iterations with a predefined threshold. If convergence criteria are met, exit the algorithm; otherwise, return to step 2.</p></li>
<li><p><strong>Output</strong>: Once convergence is achieved, the final transformation parameters represent the aligned positions of the source points with respect to the target points.</p></li>
</ol>
<p>Now, let’s go through each step of the CPD algorithm in more detail.</p>
</section>
<section id="expectation-step">
<h3>Expectation Step<a class="headerlink" href="#expectation-step" title="Link to this heading">#</a></h3>
<p>In the Expectation step, we compute soft correspondences between points in (X) and (Y). This is done by estimating the posterior probability that a point in (X) corresponds to a point in (Y) given the current transformation (T) and the parameters of the GMM. The soft correspondences are computed using Bayes’ theorem:</p>
<div class="math notranslate nohighlight">
\[
P(w_{ij} | x_i, y_j, T) = \frac{\pi_j \mathcal{N}(y_j | \mu_j, \Sigma_j)}{\sum_{k=1}^M \pi_k \mathcal{N}(y_j | \mu_k, \Sigma_k)}  
\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\((w_{ij})\)</span> is the soft correspondence weight between <span class="math notranslate nohighlight">\((x_i)\)</span> and <span class="math notranslate nohighlight">\((y_j)\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\((\pi_j)\)</span> is the mixing coefficient of the <span class="math notranslate nohighlight">\((j^{th})\)</span> component of the GMM.</p></li>
<li><p><span class="math notranslate nohighlight">\((\mathcal{N}(y_j | \mu_j, \Sigma_j))\)</span> is the Gaussian distribution representing the <span class="math notranslate nohighlight">\((j^{th})\)</span> component of the GMM.</p></li>
<li><p>The denominator is the normalization term ensuring that the weights sum up to 1.</p></li>
</ul>
</section>
<section id="maximization-step">
<h3>Maximization Step<a class="headerlink" href="#maximization-step" title="Link to this heading">#</a></h3>
<p>In the Maximization step, we update the parameters of the GMM and estimate the transformation (T) that maximizes the likelihood of the soft correspondences. This involves solving an optimization problem to find the optimal transformation and updating the parameters of the GMM using the weighted point correspondences.</p>
</section>
</section>
<section id="point-cloud-registration-with-cpd-example-code">
<h2>Point Cloud Registration with CPD Example Code<a class="headerlink" href="#point-cloud-registration-with-cpd-example-code" title="Link to this heading">#</a></h2>
<section id="https-siavashk-github-io-2017-05-14-coherent-point-drift">
<h3>(<a class="reference external" href="https://siavashk.github.io/2017/05/14/coherent-point-drift/">https://siavashk.github.io/2017/05/14/coherent-point-drift/</a>)<a class="headerlink" href="#https-siavashk-github-io-2017-05-14-coherent-point-drift" title="Link to this heading">#</a></h3>
<p>Let’s start off with a simple toy example. Assume that we have two point clouds ( <span class="math notranslate nohighlight">\(X = { X1, X2, X3 }\)</span> ) and ( <span class="math notranslate nohighlight">\(Y = { Y1, Y2, Y3 }\)</span> ) . These point clouds are shown in Figure 1 with red and blue circles, respectively. Our goal is to find the transformation that best aligns the two point clouds.</p>
<p>In this toy example, the unknown transformation is a rotation around the origin (parameterized by <span class="math notranslate nohighlight">\(\theta\)</span> followed by a translation (parameterized by (t)). Assume, the actual value of the unknown parameters is { <span class="math notranslate nohighlight">\(\theta^{\circ}\)</span>, t=(0.2, 0.2) } . We can use numpy to define the two point clouds as seen in the following code snippet:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># transformation parameters</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.0</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">]])</span>

<span class="c1"># rotation matrix</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
              <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>

<span class="n">xLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X1&quot;</span><span class="p">,</span> <span class="s2">&quot;X2&quot;</span><span class="p">,</span> <span class="s2">&quot;X3&quot;</span><span class="p">]</span>
<span class="n">yLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Y1&quot;</span><span class="p">,</span> <span class="s2">&quot;Y2&quot;</span><span class="p">,</span> <span class="s2">&quot;Y3&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Plotting the two point clouds results in Figure 1. Now, since this is a toy example, we already know the correspondences between points in the two point clouds. The corresponding points are linked using the black dashed line. If the correspondences are known, the solution to the rigid registration is known as the orthogonal Procrustes problem:</p>
<div class="math notranslate nohighlight">
\[\mathrm{argmin}_{R,t}\Vert{X - RY - t}\Vert^2, \quad \mathrm{s.t} \quad R^TR=I\]</div>
<p><img alt="Point Cloud Registration" src="_images/registration1_1_0.png" /><br/></p>
</section>
</section>
<section id="missing-correspondences">
<h2>Missing Correspondences<a class="headerlink" href="#missing-correspondences" title="Link to this heading">#</a></h2>
<p>When correspondence is not explicitly known, point cloud registration algorithms implicitly assume that correspondence can be inferred through point proximity. In other words, points that are spatially close to each other correspond to one another.</p>
<p>We can assign an arbitrary correspondence probability to point clouds based on proximity. Figure 2 shows an example probability distribution based on proximity.</p>
<p>Points that are closer than a radius of (r=0.2) would confident matches, and we would assign a correspondence confidence of (p=1.0) to them. Pairs such as ((X1, Y1)) and ((X2, Y2)) pairs have a distance between (r=0.2) and (r=0.4) units are probable but not confident matches, so we could assign a probability of (p=0.5) to them. Beyond this, there is probably no correspondence, so our probability would drop to zero.</p>
<p>Even though this approach is quite simple, it provides two distinct advantages. First, it allows us to assign correspondences so that we can solve the registration as a Procrustes problem. Furthermore, it also allows us to weigh the loss functional according to the correspondence probability.
<br>
<img alt="Point Cloud Correspondences" src="_images/registration1_2_0.png" /><br/></p>
</section>
<section id="gaussian-mixture-models">
<h2>Gaussian Mixture Models<a class="headerlink" href="#gaussian-mixture-models" title="Link to this heading">#</a></h2>
<p>We will now side step from the point cloud registration problem briefly. Instead of dealing with (X, Y) point clouds directly, we construct a GMM from the moving point cloud, (Y), and treat (X) as observations from that GMM. In Figure 3, we have constructed a GMM where the three Gaussians have a variance of 0.75 units. Blue points, i.e. Gaussian centroids, are the transformed moving points ((Y)). Red points, i.e. the fixed point cloud (X), are observations from this GMM. Isocontours represent the log-likelihood that red points are sampled from this GMM.</p>
<p><br><img alt="Constructed GMM" src="_images/registration1_3_0.png" /><br/></p>
</section>
<section id="gmm-based-registration">
<h2>GMM-based Registration<a class="headerlink" href="#gmm-based-registration" title="Link to this heading">#</a></h2>
<p>In order to perform registration, we have to solve correspondence and moving point cloud transformation problems simultaneously. This is done through expectation-maximization (EM) optimization. To solve the correspondence problem, we need to find which Gaussian the observed point cloud was sampled from (E-step). This provides us with correspondence probability, similar to Figure 2. Once correspondences probabilities are known, we maximize the negative log-likelihood that the observed points were sampled from the GMM with respect to transformation parameters (M-step).</p>
</section>
<section id="id1">
<h2>Expectation Step<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>In Figure 3, if there was only one Gaussian component in the mixture, then the probability that a point (x) is sampled from this Gaussian is given using probability density distribution of the <a class="reference external" href="https://en.wikipedia.org/wiki/Multivariate_normal_distribution#Density_function">multivairate normal distribution</a>. For the 2D case, with isotropic Gaussians, this simplifies to:</p>
<div class="math notranslate nohighlight">
\[p(X) = \frac{1}{\sqrt{2\pi\sigma^2}}\exp({-\frac{\Vert{X - RY - t}\Vert^2}{2\sigma^2}})\]</div>
<p>However, since we are dealing with multiple Gaussians, we need to normalize this probability by the contribution of all Gaussian centroids. In the pycpd package, this is achieved (minor tweaks to simplify the explanation) using the following snippet:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="n">EstepResult</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;EstepResult&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;pt1&quot;</span><span class="p">,</span> <span class="s2">&quot;p1&quot;</span><span class="p">,</span> <span class="s2">&quot;px&quot;</span><span class="p">,</span> <span class="s2">&quot;n_p&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">expectation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_source</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EstepResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expectation step for CPD&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">t_source</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">target</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;source and target must have 2 dimensions.&quot;</span>
        <span class="n">pmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_module</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">t_source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="s2">&quot;sqeuclidean&quot;</span><span class="p">)</span>
        <span class="c1"># Probability matrix: pmat{ij} is the probability that moving point i corresponds to fixed point j</span>
        <span class="c1"># pmat = self.xp.stack([self.xp.sum(self.xp.square(target - ts), axis=1) for ts in t_source])</span>
        <span class="n">pmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pmat</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">))</span>

        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">t_source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">*=</span> <span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">t_source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">den</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">den</span><span class="p">[</span><span class="n">den</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="n">den</span> <span class="o">+=</span> <span class="n">c</span>

        <span class="n">pmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span>
        <span class="n">pt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">EstepResult</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h2>Maximization Step<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>Once correspondence probabilities are known, i.e. (P), we can solve for the transformation parameters. In the case of rigid registration, these transform parameters are the rotation matrix and the translation vector. In the pycpd package, this is achieved using the following snippet:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">MStep</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">Np</span><span class="p">):</span>
  <span class="n">s</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">XX</span> <span class="o">=</span> <span class="n">updateTransform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">Np</span><span class="p">)</span>
  <span class="n">sigma2</span> <span class="o">=</span> <span class="n">updateVariance</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">updateTransform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">Np</span><span class="p">):</span>
  <span class="n">muX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">Np</span><span class="p">)</span>
  <span class="n">muY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span> <span class="n">Y</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">Np</span><span class="p">)</span>

  <span class="n">XX</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">muX</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">YY</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">muY</span><span class="p">,</span> <span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

  <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">XX</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">YY</span><span class="p">)</span>

  <span class="n">U</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="p">))</span>
  <span class="n">C</span><span class="p">[</span><span class="n">D</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">))</span>

  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">C</span><span class="p">)),</span> <span class="n">V</span><span class="p">)</span>

  <span class="n">YPY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">P1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">YY</span><span class="p">,</span> <span class="n">YY</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">R</span><span class="p">))</span> <span class="o">/</span> <span class="n">YPY</span>

  <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">muX</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">muY</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">XX</span>

<span class="k">def</span> <span class="nf">updateVariance</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
  <span class="n">trAR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">R</span><span class="p">)))</span>
  <span class="n">xPx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">P1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">XX</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">sigma2</span> <span class="o">=</span> <span class="p">(</span><span class="n">xPx</span> <span class="o">-</span> <span class="n">s</span> <span class="o">*</span> <span class="n">trAR</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Np</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">sigma2</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="icp-algorithm">
<h2>ICP Algorithm<a class="headerlink" href="#icp-algorithm" title="Link to this heading">#</a></h2>
<p><strong>Input:</strong></p>
<ul class="simple">
<li><p>Source point cloud ( A ) with ( N ) points ( <span class="math notranslate nohighlight">\({a}_i\)</span> )</p></li>
<li><p>Target point cloud ( B ) with ( N ) points ( <span class="math notranslate nohighlight">\({b}_i\)</span> )</p></li>
<li><p>Maximum number of iterations ( <span class="math notranslate nohighlight">\({max iterations}\)</span> )</p></li>
<li><p>Convergence criteria tolerance ( <span class="math notranslate nohighlight">\({tolerance}\)</span> )</p></li>
</ul>
<p><strong>Output:</strong></p>
<ul class="simple">
<li><p>Transformation matrix ( T ) that aligns ( A ) to ( B )</p></li>
<li><p>Euclidean distances ( <span class="math notranslate nohighlight">\({distances}\)</span> ) of the nearest neighbor</p></li>
<li><p>Number of iterations ( i ) to converge</p></li>
</ul>
<p><strong>Algorithm:</strong></p>
<ol class="arabic simple">
<li><p><strong>Initialize:</strong> Set ( T ) as an identity matrix.</p></li>
<li><p><strong>Iterate:</strong> Repeat until convergence or reaching maximum iterations:</p>
<ul class="simple">
<li><p><strong>Find Correspondences:</strong> For each point ( <span class="math notranslate nohighlight">\({a}_i\)</span> ) in ( A ), find its nearest neighbor ( <span class="math notranslate nohighlight">\({b}_j\)</span> ) in ( B ).</p></li>
<li><p><strong>Compute Transformation:</strong> Calculate the transformation ( T ) that best aligns ( A ) to ( B ) based on the correspondences.</p></li>
<li><p><strong>Update Source:</strong> Apply the transformation ( T ) to ( A ).</p></li>
<li><p><strong>Check Convergence:</strong> If the change in mean squared error between consecutive iterations is below the tolerance, break the loop.</p></li>
</ul>
</li>
<li><p><strong>Calculate Final Transformation:</strong> Calculate the final transformation ( T ) using the best fit transform between the original ( {A} ) and the transformed ( A ).</p></li>
<li><p><strong>Return Results:</strong> Return ( T ), distances ( <span class="math notranslate nohighlight">\({distances}\)</span> ), and the number of iterations ( i ).</p></li>
</ol>
<p><strong>To note:</strong></p>
<ul class="simple">
<li><p>The transformation ( T ) generally includes a rotation matrix ( R ) and a translation vector ( t ).</p></li>
<li><p>The best fit transform can be computed using methods like Singular Value Decomposition (SVD) or Quaternion-based optimization.</p></li>
<li><p>ICP is sensitive to initialization, and multiple initial guesses may be required for optimal convergence.</p></li>
</ul>
<p>The best_fit_transform function calculates the least-squares best-fit transform that maps corresponding points from one point set to another in m spatial dimensions. Given two sets of corresponding points A and B, it computes the optimal rotation matrix R and translation vector t that minimize the squared Euclidean distance between the transformed points and their corresponding points in the other set. This function is a fundamental building block used in point set registration algorithms like ICP (Iterative Closest Point) and CPD (Coherent Point Drift).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>

<span class="k">def</span> <span class="nf">best_fit_transform</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculates the least-squares best-fit transform that maps corresponding points A to B in m spatial dimensions</span>
<span class="sd">    Input:</span>
<span class="sd">      A: Nxm numpy array of corresponding points</span>
<span class="sd">      B: Nxm numpy array of corresponding points</span>
<span class="sd">    Returns:</span>
<span class="sd">      T: (m+1)x(m+1) homogeneous transformation matrix that maps A on to B</span>
<span class="sd">      R: mxm rotation matrix</span>
<span class="sd">      t: mx1 translation vector</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># get number of dimensions</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># translate points to their centroids</span>
    <span class="n">centroid_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">centroid_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">AA</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">centroid_A</span>
    <span class="n">BB</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">centroid_B</span>

    <span class="c1"># rotation matrix</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">AA</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">BB</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># special reflection case</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
       <span class="n">Vt</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
       <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># translation</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">centroid_B</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">centroid_A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># homogeneous transformation</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">T</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
    <span class="n">T</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

    <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<p>The nearest_neighbor function finds the nearest (Euclidean) neighbor in a destination point set for each point in a source point set. Given two sets of points, src and dst, it computes the Euclidean distances and indices of the nearest neighbor in the destination set for each point in the source set. This function is commonly used in point set registration algorithms to establish point correspondences between two sets of points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nearest_neighbor</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find the nearest (Euclidean) neighbor in dst for each point in src</span>
<span class="sd">    Input:</span>
<span class="sd">        src: Nxm array of points</span>
<span class="sd">        dst: Nxm array of points</span>
<span class="sd">    Output:</span>
<span class="sd">        distances: Euclidean distances of the nearest neighbor</span>
<span class="sd">        indices: dst indices of the nearest neighbor</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">dst</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">neigh</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">neigh</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
    <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">neigh</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distances</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">indices</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The icp function implements the Iterative Closest Point (ICP) algorithm, which aims to find the best-fit transform that maps points from one point set onto another. Given two sets of points, A and B, it iteratively refines the transformation parameters to minimize the Euclidean distance between corresponding points. This iterative process continues until convergence or a maximum number of iterations is reached. The function returns the final homogeneous transformation matrix, Euclidean distances of the nearest neighbor, and the number of iterations taken to converge.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">icp</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">init_pose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The Iterative Closest Point method: finds best-fit transform that maps points A on to points B</span>
<span class="sd">    Input:</span>
<span class="sd">        A: Nxm numpy array of source mD points</span>
<span class="sd">        B: Nxm numpy array of destination mD point</span>
<span class="sd">        init_pose: (m+1)x(m+1) homogeneous transformation</span>
<span class="sd">        max_iterations: exit algorithm after max_iterations</span>
<span class="sd">        tolerance: convergence criteria</span>
<span class="sd">    Output:</span>
<span class="sd">        T: final homogeneous transformation that maps A on to B</span>
<span class="sd">        distances: Euclidean distances (errors) of the nearest neighbor</span>
<span class="sd">        i: number of iterations to converge</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># get number of dimensions</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># make points homogeneous, copy them to maintain the originals</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">src</span><span class="p">[:</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">dst</span><span class="p">[:</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># apply the initial pose estimation</span>
    <span class="k">if</span> <span class="n">init_pose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">init_pose</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

    <span class="n">prev_error</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="c1"># find the nearest neighbors between the current source and destination points</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nearest_neighbor</span><span class="p">(</span><span class="n">src</span><span class="p">[:</span><span class="n">m</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dst</span><span class="p">[:</span><span class="n">m</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># compute the transformation between the current source and nearest destination points</span>
        <span class="n">T</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">best_fit_transform</span><span class="p">(</span><span class="n">src</span><span class="p">[:</span><span class="n">m</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dst</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># update the current source</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

        <span class="c1"># check error</span>
        <span class="n">mean_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">prev_error</span> <span class="o">-</span> <span class="n">mean_error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">prev_error</span> <span class="o">=</span> <span class="n">mean_error</span>

    <span class="c1"># calculate final transformation</span>
    <span class="n">T</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">best_fit_transform</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">src</span><span class="p">[:</span><span class="n">m</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">i</span>
</pre></div>
</div>
</div>
</div>
<p>The rotation_matrix function generates a rotation matrix for a given axis and angle of rotation. It takes an axis vector and an angle in radians as inputs and returns a 3x3 rotation matrix representing the rotation around the given axis. This function is commonly used in various geometric transformations and is used for generating rotation matrices required in ICP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rotation_matrix</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">axis</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="o">-</span><span class="n">d</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">)],</span>
                  <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="p">),</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="o">-</span><span class="n">d</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">)],</span>
                  <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">),</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">visualize_point_cloud</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">title_A</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">title_B</span><span class="o">=</span><span class="s1">&#39;Transformed&#39;</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="c1"># Plotting original point cloud</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">A</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">title_A</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_A</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Plotting transformed point cloud</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">B</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">B</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">B</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">title_B</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_B</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constants</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>                                    <span class="c1"># number of random points in the dataset</span>
<span class="n">num_tests</span> <span class="o">=</span> <span class="mi">100</span>                             <span class="c1"># number of test iterations</span>
<span class="n">dim</span> <span class="o">=</span> <span class="mi">3</span>                                     <span class="c1"># number of dimensions of the points</span>
<span class="n">noise_sigma</span> <span class="o">=</span> <span class="mf">.01</span>                           <span class="c1"># standard deviation error to be added</span>
<span class="n">translation</span> <span class="o">=</span> <span class="mf">.1</span>                            <span class="c1"># max translation of the test set</span>
<span class="n">rotation</span> <span class="o">=</span> <span class="mf">.1</span>                               <span class="c1"># max rotation (radians) of the test set</span>

<span class="k">def</span> <span class="nf">test_best_fit</span><span class="p">():</span>

    <span class="c1"># Generate a random dataset</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>

    <span class="n">total_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">):</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

        <span class="c1"># Translate</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">*</span><span class="n">translation</span>
        <span class="n">B</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="c1"># Rotate</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">*</span><span class="n">rotation</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Add noise</span>
        <span class="n">B</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_sigma</span>

        <span class="c1"># Find best fit transform</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">T</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">best_fit_transform</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="c1"># Make C a homogeneous representation of B</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">C</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span>

        <span class="c1"># Transform C</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">A</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">noise_sigma</span><span class="p">)</span> <span class="c1"># T should transform B (or C) to A</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">noise_sigma</span><span class="p">)</span>      <span class="c1"># t and t1 should be inverses</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">noise_sigma</span><span class="p">)</span>     <span class="c1"># R and R1 should be inverses</span>
    <span class="n">visualize_point_cloud</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">title_A</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">title_B</span><span class="o">=</span><span class="s1">&#39;Transformed&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;best fit time: </span><span class="si">{:.3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">num_tests</span><span class="p">))</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">test_icp</span><span class="p">():</span>

    <span class="c1"># Generate a random dataset</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>

    <span class="n">total_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">):</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

        <span class="c1"># Translate</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">*</span><span class="n">translation</span>
        <span class="n">B</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="c1"># Rotate</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">rotation</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Add noise</span>
        <span class="n">B</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_sigma</span>

        <span class="c1"># Shuffle to disrupt correspondence</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

        <span class="c1"># Run ICP</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">T</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">iterations</span> <span class="o">=</span> <span class="n">icp</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="c1"># Make C a homogeneous representation of B</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">C</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

        <span class="c1"># Transform C</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="o">*</span><span class="n">noise_sigma</span>                   <span class="c1"># mean error should be small</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">noise_sigma</span><span class="p">)</span>     <span class="c1"># T and R should be inverses</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">t</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">noise_sigma</span><span class="p">)</span>        <span class="c1"># T and t should be inverses</span>
    <span class="n">visualize_point_cloud</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">title_A</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">title_B</span><span class="o">=</span><span class="s1">&#39;Transformed&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean Error:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;icp time: </span><span class="si">{:.3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_time</span><span class="o">/</span><span class="n">num_tests</span><span class="p">))</span>

    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_best_fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b46ec1c31d1450b10117f7f4c04abe7be49513401ad3e126fb3ca0327e63550a.png" src="_images/b46ec1c31d1450b10117f7f4c04abe7be49513401ad3e126fb3ca0327e63550a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>best fit time: 5e-05
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_icp</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/118ce2f399919dc9658881ee4def3ab0367ff2c6927a3eca043a8368a0f67e18.png" src="_images/118ce2f399919dc9658881ee4def3ab0367ff2c6927a3eca043a8368a0f67e18.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Error: 0.016735989286075965
icp time: 0.00288
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cpd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Coherent Point Drift (CPD) algorithm: finds best-fit transform that maps points A onto points B</span>
<span class="sd">    Input:</span>
<span class="sd">        A: Nxm numpy array of source mD points</span>
<span class="sd">        B: Nxm numpy array of destination mD points</span>
<span class="sd">        max_iterations: exit algorithm after max_iterations</span>
<span class="sd">        tolerance: convergence criteria</span>
<span class="sd">    Output:</span>
<span class="sd">        T: final homogeneous transformation that maps A onto B</span>
<span class="sd">        distances: Euclidean distances (errors) of the nearest neighbor</span>
<span class="sd">        i: number of iterations to converge</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># get number of dimensions</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># make points homogeneous, copy them to maintain the originals</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">src</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">dst</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">prev_error</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="c1"># E-step: calculate the expected correspondence probabilities</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">calculate_correspondence_probabilities</span><span class="p">(</span><span class="n">src</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dst</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># M-step: update the transformation parameters</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">update_transformation</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>

        <span class="c1"># update the current source</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

        <span class="c1"># check error</span>
        <span class="n">mean_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">prev_error</span> <span class="o">-</span> <span class="n">mean_error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">prev_error</span> <span class="o">=</span> <span class="n">mean_error</span>

    <span class="c1"># calculate final transformation</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">update_transformation</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">P</span><span class="p">),</span> <span class="n">i</span>


<span class="k">def</span> <span class="nf">calculate_correspondence_probabilities</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the expected correspondence probabilities between points in src and dst</span>
<span class="sd">    Input:</span>
<span class="sd">        src: Nxm array of source points</span>
<span class="sd">        dst: Nxm array of destination points</span>
<span class="sd">    Output:</span>
<span class="sd">        P: N-dimensional array of correspondence probabilities</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nearest_neighbor</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">sigma2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">distances</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">P</span>


<span class="k">def</span> <span class="nf">update_transformation</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Update the transformation between src and dst based on the correspondence probabilities P</span>
<span class="sd">    Input:</span>
<span class="sd">        src: (m+1)xN array of source points</span>
<span class="sd">        dst: (m+1)xN array of destination points</span>
<span class="sd">        P: N-dimensional array of correspondence probabilities</span>
<span class="sd">    Output:</span>
<span class="sd">        T: (m+1)x(m+1) homogeneous transformation matrix</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># calculate normalization factor</span>
    <span class="n">sum_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

    <span class="c1"># weighted centering</span>
    <span class="n">mu_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_P</span>
    <span class="n">mu_dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_P</span>

    <span class="n">src_demean</span> <span class="o">=</span> <span class="n">src</span> <span class="o">-</span> <span class="n">mu_src</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">dst_demean</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">-</span> <span class="n">mu_dst</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="c1"># cross covariance matrix</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">src_demean</span> <span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="n">dst_demean</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># singular value decomposition</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>

    <span class="c1"># compute rotation and translation</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">mu_dst</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">mu_src</span><span class="p">)</span>

    <span class="c1"># ensure R is a 3x3 matrix</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># homogeneous transformation</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># number of dimensions</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">T</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
    <span class="n">T</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:</span><span class="n">m</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_cpd</span><span class="p">():</span>

    <span class="n">total_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">):</span>
        <span class="c1"># Generate a random dataset A</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>

        <span class="c1"># Create a copy of A and apply transformations</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

        <span class="c1"># Translate</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">translation</span>
        <span class="n">B</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="c1"># Rotate</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">rotation</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Add noise</span>
        <span class="n">B</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_sigma</span>

        <span class="c1"># Shuffle to disrupt correspondence</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

        <span class="c1"># Run CPD</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">T</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">iterations</span> <span class="o">=</span> <span class="n">cpd</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="c1"># Apply the transformation to point set B</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))))</span>

        <span class="c1"># Transformed point set is the first m rows of C, transpose for compatibility with visualize_point_cloud</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># assert np.mean(distances) &lt; 6*noise_sigma                   # mean error should be small</span>
        <span class="c1"># assert np.allclose(T[0:3,0:3].T, R, atol=6*noise_sigma)     # T and R should be inverses</span>
        <span class="c1"># assert np.allclose(-T[0:3,3], t, atol=6*noise_sigma)        # T and t should be inverses</span>
        
    <span class="c1"># Visualize the original and transformed point sets</span>
    <span class="n">visualize_point_cloud</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">title_A</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">title_B</span><span class="o">=</span><span class="s1">&#39;Transformed&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean Error:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CPD average time: </span><span class="si">{:.3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_time</span> <span class="o">/</span> <span class="n">num_tests</span><span class="p">))</span>

    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_cpd</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/286117a3eaa66bd9c7fdcdf35834f8418f546d17fe6139e17426466cd99ec346.png" src="_images/286117a3eaa66bd9c7fdcdf35834f8418f546d17fe6139e17426466cd99ec346.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Error: 0.7679461983787543
CPD average time: 0.0126
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">open3d</span> <span class="k">as</span> <span class="nn">o3</span>
<span class="kn">import</span> <span class="nn">transforms3d</span> <span class="k">as</span> <span class="nn">t3d</span>


<span class="k">def</span> <span class="nf">estimate_normals</span><span class="p">(</span><span class="n">pcd</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">pcd</span><span class="o">.</span><span class="n">estimate_normals</span><span class="p">(</span><span class="n">search_param</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="n">pcd</span><span class="o">.</span><span class="n">orient_normals_to_align_with_direction</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">prepare_source_and_target_rigid_3d</span><span class="p">(</span><span class="n">source_filename</span><span class="p">,</span>
                                       <span class="n">noise_amp</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                                       <span class="n">n_random</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                       <span class="n">orientation</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">]),</span>
                                       <span class="n">translation</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                                       <span class="n">voxel_size</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
                                       <span class="n">normals</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_point_cloud</span><span class="p">(</span><span class="n">source_filename</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">voxel_down_sample</span><span class="p">(</span><span class="n">voxel_size</span><span class="o">=</span><span class="n">voxel_size</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">rg</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">tp</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">rands</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_random</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">rg</span> <span class="o">+</span> <span class="n">tp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">target</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">tp</span> <span class="o">+</span> <span class="n">noise_amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">rands</span><span class="p">])</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">ans</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t3d</span><span class="o">.</span><span class="n">euler</span><span class="o">.</span><span class="n">euler2mat</span><span class="p">(</span><span class="o">*</span><span class="n">orientation</span><span class="p">)</span>
    <span class="n">ans</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">translation</span>
    <span class="n">target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normals</span><span class="p">:</span>
        <span class="n">estimate_normals</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">o3</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">KDTreeSearchParamHybrid</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">max_nn</span><span class="o">=</span><span class="mi">50</span><span class="p">))</span>
        <span class="n">estimate_normals</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">o3</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">KDTreeSearchParamHybrid</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">max_nn</span><span class="o">=</span><span class="mi">50</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span>

<span class="k">def</span> <span class="nf">prepare_source_and_target_nonrigid_2d</span><span class="p">(</span><span class="n">source_filename</span><span class="p">,</span>
                                          <span class="n">target_filename</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">source_filename</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">target_filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span>


<span class="k">def</span> <span class="nf">prepare_source_and_target_nonrigid_3d</span><span class="p">(</span><span class="n">source_filename</span><span class="p">,</span>
                                          <span class="n">target_filename</span><span class="p">,</span>
                                          <span class="n">voxel_size</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="p">()</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="p">()</span>
    <span class="n">source</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">source_filename</span><span class="p">))</span>
    <span class="n">target</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">target_filename</span><span class="p">))</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">voxel_down_sample</span><span class="p">(</span><span class="n">voxel_size</span><span class="o">=</span><span class="n">voxel_size</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">voxel_down_sample</span><span class="p">(</span><span class="n">voxel_size</span><span class="o">=</span><span class="n">voxel_size</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Jupyter environment detected. Enabling Open3D WebVisualizer.
[Open3D INFO] WebRTC GUI backend enabled.
[Open3D INFO] WebRTCWindowSystem: HTTP handshake server disabled.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">probreg</span> <span class="kn">import</span> <span class="n">cpd</span>
<span class="kn">from</span> <span class="nn">probreg</span> <span class="kn">import</span> <span class="n">callbacks</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;probreg&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">prepare_source_and_target_rigid_3d</span><span class="p">(</span><span class="s1">&#39;data/bunny.pcd&#39;</span><span class="p">)</span>
<span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Open3dVisualizerCallback</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">save</span><span class="p">)]</span>
<span class="n">tf_param</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cpd</span><span class="o">.</span><span class="n">registration_cpd</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                                      <span class="n">callbacks</span><span class="o">=</span><span class="n">cbs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;result: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">t3d</span><span class="o">.</span><span class="n">euler</span><span class="o">.</span><span class="n">mat2euler</span><span class="p">(</span><span class="n">tf_param</span><span class="o">.</span><span class="n">rot</span><span class="p">)),</span><span class="n">tf_param</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">tf_param</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PointCloud with 381 points.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 0, Criteria: -6671.894851775329
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 1, Criteria: -6740.536568905538
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 2, Criteria: -6795.908837626514
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 3, Criteria: -6855.658602300051
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 4, Criteria: -6918.975335427005
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 5, Criteria: -6983.757184575563
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 6, Criteria: -7047.838901076053
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 7, Criteria: -7109.340169890465
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 8, Criteria: -7166.827716082884
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 9, Criteria: -7219.357836018864
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 10, Criteria: -7266.435640172051
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 11, Criteria: -7307.931296756868
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 12, Criteria: -7343.985355239
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 13, Criteria: -7374.921714199025
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 14, Criteria: -7401.175826047194
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 15, Criteria: -7423.239352565915
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 16, Criteria: -7441.619648426247
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 17, Criteria: -7456.811578291456
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 18, Criteria: -7469.2791555248095
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 19, Criteria: -7479.44475901819
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 20, Criteria: -7487.684011243648
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 21, Criteria: -7494.32471561664
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 22, Criteria: -7499.648543556737
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 23, Criteria: -7503.894432973448
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 24, Criteria: -7507.262908418941
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 25, Criteria: -7509.92075247235
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 26, Criteria: -7512.005641678099
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 27, Criteria: -7513.630505704383
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 28, Criteria: -7514.8874767982525
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 29, Criteria: -7515.851372792849
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 30, Criteria: -7516.582707112002
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 31, Criteria: -7517.13024978905
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 32, Criteria: -7517.533180114131
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 33, Criteria: -7517.822878701505
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 34, Criteria: -7518.024407959105
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 35, Criteria: -7518.15772759593
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 36, Criteria: -7518.238687585734
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 37, Criteria: -7518.279835998941
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 38, Criteria: -7518.291073983992
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 39, Criteria: -7518.280185306256
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 40, Criteria: -7518.253263433289
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 41, Criteria: -7518.215055268316
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 42, Criteria: -7518.16923728827
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 43, Criteria: -7518.118637008187
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 44, Criteria: -7518.065410320334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 45, Criteria: -7518.011183287215
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 46, Criteria: -7517.9571653449275
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 47, Criteria: -7517.904239543952
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 48, Criteria: -7517.853034369753
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 49, Criteria: -7517.803980803936
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>result:  [ 4.51391244  3.17941056 29.62188664] 1.0505037209060204 [-0.00342736 -0.00252268 -0.01278116]
</pre></div>
</div>
</div>
</div>
<p><br><img alt="Bunny Point Cloud Example with Proberg Package" src="_images/image_0049.jpg" /><br/></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">prepare_source_and_target_rigid_3d</span><span class="p">(</span><span class="s1">&#39;data/bunny.pcd&#39;</span><span class="p">)</span>

<span class="n">vis</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">Visualizer</span><span class="p">()</span>
<span class="n">vis</span><span class="o">.</span><span class="n">create_window</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">source</span><span class="o">.</span><span class="n">paint_uniform_color</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">target</span><span class="o">.</span><span class="n">paint_uniform_color</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">result</span><span class="o">.</span><span class="n">paint_uniform_color</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">vis</span><span class="o">.</span><span class="n">add_geometry</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">vis</span><span class="o">.</span><span class="n">add_geometry</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="n">vis</span><span class="o">.</span><span class="n">add_geometry</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">icp_iteration</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">save_image</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">icp_iteration</span><span class="p">):</span>
    <span class="n">reg_p2p</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">pipelines</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">registration_icp</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">o3</span><span class="o">.</span><span class="n">pipelines</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">TransformationEstimationPointToPoint</span><span class="p">(),</span>
                <span class="n">o3</span><span class="o">.</span><span class="n">pipelines</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">ICPConvergenceCriteria</span><span class="p">(</span><span class="n">max_iteration</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">result</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">reg_p2p</span><span class="o">.</span><span class="n">transformation</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">poll_events</span><span class="p">()</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">update_renderer</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">save_image</span><span class="p">:</span>
        <span class="n">vis</span><span class="o">.</span><span class="n">capture_screen_image</span><span class="p">(</span><span class="s2">&quot;image_</span><span class="si">%04d</span><span class="s2">.jpg&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
<span class="n">vis</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PointCloud with 381 points.
</pre></div>
</div>
</div>
</div>
<p><br><img alt="Bunny Point Cloud Example with ICP" src="_images/image_00491.jpg" /><br/></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">prepare_source_and_target_rigid_3d</span><span class="p">(</span><span class="s1">&#39;data/cloud_0.pcd&#39;</span><span class="p">)</span>

<span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Open3dVisualizerCallback</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">save</span><span class="p">)]</span>
<span class="n">tf_param</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cpd</span><span class="o">.</span><span class="n">registration_cpd</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                                      <span class="n">callbacks</span><span class="o">=</span><span class="n">cbs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;result: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">t3d</span><span class="o">.</span><span class="n">euler</span><span class="o">.</span><span class="n">mat2euler</span><span class="p">(</span><span class="n">tf_param</span><span class="o">.</span><span class="n">rot</span><span class="p">)),</span><span class="n">tf_param</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">tf_param</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PointCloud with 6534 points.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 0, Criteria: 3058.0655096113323
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 1, Criteria: 1767.973459555933
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 2, Criteria: 297.3964319901024
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 3, Criteria: -1457.8755044536374
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 4, Criteria: -3351.4393296148282
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 5, Criteria: -5189.671922843918
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 6, Criteria: -6823.988682907468
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 7, Criteria: -8185.083111354254
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 8, Criteria: -9266.147202665652
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 9, Criteria: -10095.718323405797
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 10, Criteria: -10716.638998760804
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 11, Criteria: -11173.188261015732
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 12, Criteria: -11504.687555303884
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 13, Criteria: -11743.279393063454
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 14, Criteria: -11913.946763508957
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 15, Criteria: -12035.49385768308
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 16, Criteria: -12121.780899412417
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 17, Criteria: -12182.884203132246
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 18, Criteria: -12226.062884468844
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 19, Criteria: -12256.515192188104
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 20, Criteria: -12277.948802275268
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 21, Criteria: -12293.00117814948
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 22, Criteria: -12303.54501424138
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 23, Criteria: -12310.908171482724
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 24, Criteria: -12316.031133102868
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 25, Criteria: -12319.579322164629
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 26, Criteria: -12322.023039533118
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 27, Criteria: -12323.69427652535
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 28, Criteria: -12324.827055821826
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 29, Criteria: -12325.586058655266
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 30, Criteria: -12326.086929721825
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 31, Criteria: -12326.410672599864
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span> <span class="n">line</span> <span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Open3dVisualizerCallback</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">save</span><span class="p">)]</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">tf_param</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cpd</span><span class="o">.</span><span class="n">registration_cpd</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                                       <span class="n">callbacks</span><span class="o">=</span><span class="n">cbs</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;result: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">t3d</span><span class="o">.</span><span class="n">euler</span><span class="o">.</span><span class="n">mat2euler</span><span class="p">(</span><span class="n">tf_param</span><span class="o">.</span><span class="n">rot</span><span class="p">)),</span><span class="n">tf_param</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">tf_param</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

<span class="nn">File D:\PointSetRegistration\probreg\probreg\cpd.py:456,</span> in <span class="ni">registration_cpd</span><span class="nt">(source, target, tf_type_name, w, maxiter, tol, callbacks, use_cuda, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">454</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown transformation type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tf_type_name</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">455</span> <span class="n">cpd</span><span class="o">.</span><span class="n">set_callbacks</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">456</span> <span class="k">return</span> <span class="n">cpd</span><span class="o">.</span><span class="n">registration</span><span class="p">(</span><span class="n">cv</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="n">w</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>

<span class="nn">File D:\PointSetRegistration\probreg\probreg\cpd.py:112,</span> in <span class="ni">CoherentPointDrift.registration</span><span class="nt">(self, target, w, maxiter, tol)</span>
<span class="g g-Whitespace">    </span><span class="mi">110</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">111</span>     <span class="n">t_source</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">112</span>     <span class="n">estep_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectation_step</span><span class="p">(</span><span class="n">t_source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">sigma2</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">113</span>     <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximization_step</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">estep_res</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">sigma2</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>     <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>

<span class="nn">File D:\PointSetRegistration\probreg\probreg\cpd.py:85,</span> in <span class="ni">CoherentPointDrift.expectation_step</span><span class="nt">(self, t_source, target, sigma2, w)</span>
<span class="g g-Whitespace">     </span><span class="mi">82</span> <span class="n">den</span> <span class="o">+=</span> <span class="n">c</span>
<span class="g g-Whitespace">     </span><span class="mi">84</span> <span class="n">pmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">85</span> <span class="n">pt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span> <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">87</span> <span class="n">px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

<span class="nn">File ~\AppData\Local\Programs\Python\Python310\lib\site-packages\numpy\core\fromnumeric.py:2313,</span> in <span class="ni">sum</span><span class="nt">(a, axis, dtype, out, keepdims, initial, where)</span>
<span class="g g-Whitespace">   </span><span class="mi">2310</span>         <span class="k">return</span> <span class="n">out</span>
<span class="g g-Whitespace">   </span><span class="mi">2311</span>     <span class="k">return</span> <span class="n">res</span>
<span class="ne">-&gt; </span><span class="mi">2313</span> <span class="k">return</span> <span class="n">_wrapreduction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2314</span>                       <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">)</span>

<span class="nn">File ~\AppData\Local\Programs\Python\Python310\lib\site-packages\numpy\core\fromnumeric.py:88,</span> in <span class="ni">_wrapreduction</span><span class="nt">(obj, ufunc, method, axis, dtype, out, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span>             <span class="k">return</span> <span class="n">reduction</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="o">**</span><span class="n">passkwargs</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">88</span> <span class="k">return</span> <span class="n">ufunc</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="o">**</span><span class="n">passkwargs</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p><br><img alt="Cloud Point Cloud Example with CPD" src="_images/image_0041.jpg" /><br/></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">prepare_source_and_target_rigid_3d</span><span class="p">(</span><span class="s1">&#39;data/cloud_0.pcd&#39;</span><span class="p">)</span>

<span class="n">vis</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">Visualizer</span><span class="p">()</span>
<span class="n">vis</span><span class="o">.</span><span class="n">create_window</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">source</span><span class="o">.</span><span class="n">paint_uniform_color</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">target</span><span class="o">.</span><span class="n">paint_uniform_color</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">result</span><span class="o">.</span><span class="n">paint_uniform_color</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">vis</span><span class="o">.</span><span class="n">add_geometry</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">vis</span><span class="o">.</span><span class="n">add_geometry</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="n">vis</span><span class="o">.</span><span class="n">add_geometry</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">icp_iteration</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">save_image</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">icp_iteration</span><span class="p">):</span>
    <span class="n">reg_p2p</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">pipelines</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">registration_icp</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">o3</span><span class="o">.</span><span class="n">pipelines</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">TransformationEstimationPointToPoint</span><span class="p">(),</span>
                <span class="n">o3</span><span class="o">.</span><span class="n">pipelines</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">ICPConvergenceCriteria</span><span class="p">(</span><span class="n">max_iteration</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">result</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">reg_p2p</span><span class="o">.</span><span class="n">transformation</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">poll_events</span><span class="p">()</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">update_renderer</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">save_image</span><span class="p">:</span>
        <span class="n">vis</span><span class="o">.</span><span class="n">capture_screen_image</span><span class="p">(</span><span class="s2">&quot;image_</span><span class="si">%04d</span><span class="s2">.jpg&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
<span class="n">vis</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PointCloud with 6534 points.
</pre></div>
</div>
</div>
</div>
<p><br><img alt="Cloud Point Cloud Example with ICP" src="_images/image_00492.jpg" /><br/></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">prepare_source_and_target_nonrigid_2d</span><span class="p">(</span><span class="s1">&#39;data/fish_source.txt&#39;</span><span class="p">,</span>
                                                             <span class="s1">&#39;data/fish_target.txt&#39;</span><span class="p">)</span>
<span class="n">cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Plot2DCallback</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)]</span>
<span class="n">tf_param</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cpd</span><span class="o">.</span><span class="n">registration_cpd</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="s1">&#39;affine&#39;</span><span class="p">,</span>
                                      <span class="n">callbacks</span><span class="o">=</span><span class="n">cbs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8f717179979b8d839a5530db65d37ba05fc7f778ddf4e92236286a3b21b95b51.png" src="_images/8f717179979b8d839a5530db65d37ba05fc7f778ddf4e92236286a3b21b95b51.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 0, Criteria: 11.340472645928003
</pre></div>
</div>
<img alt="_images/12ad478e7173356898ab2f1337d50db992a03935cd468768a235a305a5732fe4.png" src="_images/12ad478e7173356898ab2f1337d50db992a03935cd468768a235a305a5732fe4.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 1, Criteria: 1.9522256942594538
</pre></div>
</div>
<img alt="_images/97c95c6f2b6a1a4256052808684d138a7798edf4f15a326264790c0fac0681e6.png" src="_images/97c95c6f2b6a1a4256052808684d138a7798edf4f15a326264790c0fac0681e6.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 2, Criteria: -6.639663051990155
</pre></div>
</div>
<img alt="_images/9aad8cbc71aa86967a2bd6bb1d63c779c10a456c1ba98563e9f79180f4f5b6b8.png" src="_images/9aad8cbc71aa86967a2bd6bb1d63c779c10a456c1ba98563e9f79180f4f5b6b8.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 3, Criteria: -15.90011871599792
</pre></div>
</div>
<img alt="_images/5cb66d39e2705e17866a610732b05e786b61c3d45cceb059f1f317cd8a66873c.png" src="_images/5cb66d39e2705e17866a610732b05e786b61c3d45cceb059f1f317cd8a66873c.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 4, Criteria: -26.25192770762908
</pre></div>
</div>
<img alt="_images/0b997fba22b1c2e9776367d22199bfa8f70d40aac2d51c322d69c73549a7a39d.png" src="_images/0b997fba22b1c2e9776367d22199bfa8f70d40aac2d51c322d69c73549a7a39d.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 5, Criteria: -38.63217528497373
</pre></div>
</div>
<img alt="_images/b65eac82387ec4e8bcd23a218c2fb05bf73ec00a5e4c35d11eed3a659b93cc23.png" src="_images/b65eac82387ec4e8bcd23a218c2fb05bf73ec00a5e4c35d11eed3a659b93cc23.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 6, Criteria: -53.85933692601992
</pre></div>
</div>
<img alt="_images/fa8c098fcb585aa729056065d185901a29c41c215c9a47a880954286b20718f4.png" src="_images/fa8c098fcb585aa729056065d185901a29c41c215c9a47a880954286b20718f4.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 7, Criteria: -72.42386992690886
</pre></div>
</div>
<img alt="_images/8719d2c22c9cc0777664a480563bdd594c56a88833df9e12227dfc1c17721717.png" src="_images/8719d2c22c9cc0777664a480563bdd594c56a88833df9e12227dfc1c17721717.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 8, Criteria: -94.6382966351424
</pre></div>
</div>
<img alt="_images/f4cdede5356bb890d558c18b2453c20a0d41d8ca25e89ffe3a18f972799b33ec.png" src="_images/f4cdede5356bb890d558c18b2453c20a0d41d8ca25e89ffe3a18f972799b33ec.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 9, Criteria: -120.55759368675953
</pre></div>
</div>
<img alt="_images/6ebb487851dfd28e6e2f141b1862a068c17b5ed7aa8ff08075887ddf8058b307.png" src="_images/6ebb487851dfd28e6e2f141b1862a068c17b5ed7aa8ff08075887ddf8058b307.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 10, Criteria: -149.19661950236275
</pre></div>
</div>
<img alt="_images/38302cf8fe0d35e0f1e4513de5d75537758121e4d98342d0ba3c6b80c4a03a15.png" src="_images/38302cf8fe0d35e0f1e4513de5d75537758121e4d98342d0ba3c6b80c4a03a15.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 11, Criteria: -178.10603046353128
</pre></div>
</div>
<img alt="_images/4abcc3c38a1a5a96d9f15bd5f784c0012450b3848b08fcae934b4acbd123981e.png" src="_images/4abcc3c38a1a5a96d9f15bd5f784c0012450b3848b08fcae934b4acbd123981e.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 12, Criteria: -204.9277572989842
</pre></div>
</div>
<img alt="_images/b3a8ae0cf56d4bcf583b2bdbf19148dcaf89e6c0249dd0dc30a203df1401c7ac.png" src="_images/b3a8ae0cf56d4bcf583b2bdbf19148dcaf89e6c0249dd0dc30a203df1401c7ac.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 13, Criteria: -228.61872075598933
</pre></div>
</div>
<img alt="_images/0ae12aa2253807fcaec4fc4204b407a590a3cb4f5ad8c9566681b41a2aa00bc5.png" src="_images/0ae12aa2253807fcaec4fc4204b407a590a3cb4f5ad8c9566681b41a2aa00bc5.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 14, Criteria: -248.9983546875213
</pre></div>
</div>
<img alt="_images/04b4279dd3845410c56527b8371d7a9c013931364c200c08f3ac8734b4abec96.png" src="_images/04b4279dd3845410c56527b8371d7a9c013931364c200c08f3ac8734b4abec96.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 15, Criteria: -266.32857442537977
</pre></div>
</div>
<img alt="_images/6dfef9a53370ad16f169a3eeb02985c616388139509dc7d6635e6e0fb6adbb40.png" src="_images/6dfef9a53370ad16f169a3eeb02985c616388139509dc7d6635e6e0fb6adbb40.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 16, Criteria: -281.1248391040758
</pre></div>
</div>
<img alt="_images/cac1292de44333a945665961c88555943155541525d191e8d9d4134095e087b6.png" src="_images/cac1292de44333a945665961c88555943155541525d191e8d9d4134095e087b6.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 17, Criteria: -293.9186752349679
</pre></div>
</div>
<img alt="_images/6f243aeccf29752d2be4ad9a7adb1d0da5550b9fb61b1923f0c053606fd3d19c.png" src="_images/6f243aeccf29752d2be4ad9a7adb1d0da5550b9fb61b1923f0c053606fd3d19c.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 18, Criteria: -305.1520029563609
</pre></div>
</div>
<img alt="_images/61665ac2704730ddc496816209f261c505ed7024aa54336069875bcff365b342.png" src="_images/61665ac2704730ddc496816209f261c505ed7024aa54336069875bcff365b342.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 19, Criteria: -315.0581179899507
</pre></div>
</div>
<img alt="_images/e383cb8804b5f0b51bce16277f19ea33ad511c40dfafa2839cc02ed8ebdc887b.png" src="_images/e383cb8804b5f0b51bce16277f19ea33ad511c40dfafa2839cc02ed8ebdc887b.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 20, Criteria: -323.51961453478395
</pre></div>
</div>
<img alt="_images/911340737e7165d617662ab507ddf196b5cba6fbd1baab0e06f0443c8d02a54b.png" src="_images/911340737e7165d617662ab507ddf196b5cba6fbd1baab0e06f0443c8d02a54b.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 21, Criteria: -330.34193972709176
</pre></div>
</div>
<img alt="_images/73a18819447aa70854927af101d049a066080be8cf86f198d65c781406ca8e0d.png" src="_images/73a18819447aa70854927af101d049a066080be8cf86f198d65c781406ca8e0d.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 22, Criteria: -335.55601275532354
</pre></div>
</div>
<img alt="_images/62d58f46290d4443ec6a2878957241d8034a01ed261e5c125c9a77926a08c479.png" src="_images/62d58f46290d4443ec6a2878957241d8034a01ed261e5c125c9a77926a08c479.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 23, Criteria: -339.4229687577621
</pre></div>
</div>
<img alt="_images/1d9918db3c87ebcb89f52580c2cb390d1470686f69e3a4eae5125418cd9d19a0.png" src="_images/1d9918db3c87ebcb89f52580c2cb390d1470686f69e3a4eae5125418cd9d19a0.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 24, Criteria: -342.32831023428946
</pre></div>
</div>
<img alt="_images/3277548b58087826949fc9b124371d64c43ebecf1fe2eb2a52108f5132d638a9.png" src="_images/3277548b58087826949fc9b124371d64c43ebecf1fe2eb2a52108f5132d638a9.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 25, Criteria: -344.7332542687565
</pre></div>
</div>
<img alt="_images/4731f589f92ed0fae2da8c6f087d2e25b68cecb119a239c986016ded6b06f011.png" src="_images/4731f589f92ed0fae2da8c6f087d2e25b68cecb119a239c986016ded6b06f011.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 26, Criteria: -347.2360673666164
</pre></div>
</div>
<img alt="_images/09f5f20c10128663d29f599695a4551a0ea349901da72beb709d7dee96832e4b.png" src="_images/09f5f20c10128663d29f599695a4551a0ea349901da72beb709d7dee96832e4b.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 27, Criteria: -350.6241337948345
</pre></div>
</div>
<img alt="_images/67b88ed83d2c3215e5568ba3d5677e09decd810f2ebf17d3e76b6ca1175aadc6.png" src="_images/67b88ed83d2c3215e5568ba3d5677e09decd810f2ebf17d3e76b6ca1175aadc6.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 28, Criteria: -355.25437817984755
</pre></div>
</div>
<img alt="_images/6e38ddf031fe7180c118092f176cbcc7c3de472f49448dc60ee2612e2549dec6.png" src="_images/6e38ddf031fe7180c118092f176cbcc7c3de472f49448dc60ee2612e2549dec6.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 29, Criteria: -360.19510814338355
</pre></div>
</div>
<img alt="_images/9bb71bee0f02c055a6c51d645b2a601f90e9b92de0242d20533da59883b87443.png" src="_images/9bb71bee0f02c055a6c51d645b2a601f90e9b92de0242d20533da59883b87443.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 30, Criteria: -364.54275994131405
</pre></div>
</div>
<img alt="_images/a2835df7e19fa4e0b02fd056831edfe05329ac6efef8249d849b54f38442d429.png" src="_images/a2835df7e19fa4e0b02fd056831edfe05329ac6efef8249d849b54f38442d429.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 31, Criteria: -368.3651398178228
</pre></div>
</div>
<img alt="_images/2f7166f62b158c3699f6bef7ea2e395e31329763e19547ac76867ec419ee8f60.png" src="_images/2f7166f62b158c3699f6bef7ea2e395e31329763e19547ac76867ec419ee8f60.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 32, Criteria: -372.2153717671274
</pre></div>
</div>
<img alt="_images/59261f78874de455469b7224f2056588446286da82fb24088762fad430336358.png" src="_images/59261f78874de455469b7224f2056588446286da82fb24088762fad430336358.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 33, Criteria: -376.078324329664
</pre></div>
</div>
<img alt="_images/59e55500b131bbfe01cfe0c57e5fe76c19ab30ec2d3bcbcf35befef39ac69740.png" src="_images/59e55500b131bbfe01cfe0c57e5fe76c19ab30ec2d3bcbcf35befef39ac69740.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 34, Criteria: -379.23628983803764
</pre></div>
</div>
<img alt="_images/6c8c0831db6114d303a536831025937fadacb2947dee57416ef752a5b700d86d.png" src="_images/6c8c0831db6114d303a536831025937fadacb2947dee57416ef752a5b700d86d.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 35, Criteria: -381.50501711223853
</pre></div>
</div>
<img alt="_images/f94c136de654613d159d38f18b57c50ce5fbf70fbc88b24d88e9f8af710966c1.png" src="_images/f94c136de654613d159d38f18b57c50ce5fbf70fbc88b24d88e9f8af710966c1.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 36, Criteria: -383.27215216538843
</pre></div>
</div>
<img alt="_images/8f2de05a9a6f84d7c12b07d4ed98e6e128576e7b2c34b113a9b8cdbd445f69a1.png" src="_images/8f2de05a9a6f84d7c12b07d4ed98e6e128576e7b2c34b113a9b8cdbd445f69a1.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 37, Criteria: -385.1087657965903
</pre></div>
</div>
<img alt="_images/a746a1df0169188ee86be15e99f8373ee3156a71647f655f65556cf3a2c05563.png" src="_images/a746a1df0169188ee86be15e99f8373ee3156a71647f655f65556cf3a2c05563.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 38, Criteria: -387.23554891626634
</pre></div>
</div>
<img alt="_images/2005c296749077fae593f66dc07830b8caa9de8dc67a613f720f5a6b6bcf082f.png" src="_images/2005c296749077fae593f66dc07830b8caa9de8dc67a613f720f5a6b6bcf082f.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 39, Criteria: -389.17195106812835
</pre></div>
</div>
<img alt="_images/651bc8ba0ad39bc364b60d4e2d8d958a143b58edb0f409e98d31cd638d6ed05b.png" src="_images/651bc8ba0ad39bc364b60d4e2d8d958a143b58edb0f409e98d31cd638d6ed05b.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 40, Criteria: -390.6037314209917
</pre></div>
</div>
<img alt="_images/568d9522ed018e4cb83d472dc220c0c50b72ecdfa99409485243e43f7562450f.png" src="_images/568d9522ed018e4cb83d472dc220c0c50b72ecdfa99409485243e43f7562450f.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 41, Criteria: -391.5853532172715
</pre></div>
</div>
<img alt="_images/794ee0ef3b50a0c5f885661fd5541c0b6b5144cd527b70b2c2d8a9438fd725db.png" src="_images/794ee0ef3b50a0c5f885661fd5541c0b6b5144cd527b70b2c2d8a9438fd725db.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 42, Criteria: -392.25526704296226
</pre></div>
</div>
<img alt="_images/5993658bc105715d20764f2a5cf7307d586218bbcfbc2cd6b13cc8f1a2ad6df8.png" src="_images/5993658bc105715d20764f2a5cf7307d586218bbcfbc2cd6b13cc8f1a2ad6df8.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 43, Criteria: -392.7277604301511
</pre></div>
</div>
<img alt="_images/eea5900ebb832e039dd48f2cf7866832948df4b427e7a0e6dfcf103280921bc5.png" src="_images/eea5900ebb832e039dd48f2cf7866832948df4b427e7a0e6dfcf103280921bc5.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 44, Criteria: -393.080687619164
</pre></div>
</div>
<img alt="_images/8291c5a3988b68fb989145e127dec3c19e69a63ccfa1fa13c4a0f09e91d02696.png" src="_images/8291c5a3988b68fb989145e127dec3c19e69a63ccfa1fa13c4a0f09e91d02696.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 45, Criteria: -393.36576953891995
</pre></div>
</div>
<img alt="_images/96749f99025ea1c3c4d24a799bbbf173a0b8c4fc8f03763d504295a6dee7f992.png" src="_images/96749f99025ea1c3c4d24a799bbbf173a0b8c4fc8f03763d504295a6dee7f992.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 46, Criteria: -393.6216624753241
</pre></div>
</div>
<img alt="_images/3be755fc438eeea216dd503f8ea02256cfac8e30ee5b18080e0ac61c0f0f23ae.png" src="_images/3be755fc438eeea216dd503f8ea02256cfac8e30ee5b18080e0ac61c0f0f23ae.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 47, Criteria: -393.88925526041015
</pre></div>
</div>
<img alt="_images/8dc5bf6c21badad5882712540020c87520b2069def960095ae2a98df6b5c1aef.png" src="_images/8dc5bf6c21badad5882712540020c87520b2069def960095ae2a98df6b5c1aef.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 48, Criteria: -394.24322132156686
</pre></div>
</div>
<img alt="_images/0949f5bc15683d544d19323bdf035e4ee28b974ccb9f8a2064f1340f8a518379.png" src="_images/0949f5bc15683d544d19323bdf035e4ee28b974ccb9f8a2064f1340f8a518379.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 49, Criteria: -394.9026686560628
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">prepare_source_and_target_nonrigid_2d</span><span class="p">(</span><span class="s1">&#39;data/fish_source.txt&#39;</span><span class="p">,</span>
                                                             <span class="s1">&#39;data/fish_target.txt&#39;</span><span class="p">)</span>
<span class="n">cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Plot2DCallback</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)]</span>
<span class="n">tf_param</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cpd</span><span class="o">.</span><span class="n">registration_cpd</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="s1">&#39;nonrigid&#39;</span><span class="p">,</span>
                                      <span class="n">callbacks</span><span class="o">=</span><span class="n">cbs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4812d89989c4ff05881f3e1b1cd8ada5afb442dec69804a332987ee2c63b9840.png" src="_images/4812d89989c4ff05881f3e1b1cd8ada5afb442dec69804a332987ee2c63b9840.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 0, Criteria: 0.421975444241549
</pre></div>
</div>
<img alt="_images/eccf6b3c768e79e67f90ddb58245709649bf6d801d4b94010162800c76f0d943.png" src="_images/eccf6b3c768e79e67f90ddb58245709649bf6d801d4b94010162800c76f0d943.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 1, Criteria: 0.3436177679382573
</pre></div>
</div>
<img alt="_images/eaec5a1207bf2c5074adca170a8906229e186001fb8f1630e327c953a6ba34c0.png" src="_images/eaec5a1207bf2c5074adca170a8906229e186001fb8f1630e327c953a6ba34c0.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 2, Criteria: 0.29576872984077596
</pre></div>
</div>
<img alt="_images/40e19d058576bb4568d72cdc687bc279a849cf13c5ae6a4272cd896c689d99f4.png" src="_images/40e19d058576bb4568d72cdc687bc279a849cf13c5ae6a4272cd896c689d99f4.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 3, Criteria: 0.2549653927841887
</pre></div>
</div>
<img alt="_images/82d392fb3c365179bdc6a4e70b64b05903ba59a30b950d0eecae693f6791d9e5.png" src="_images/82d392fb3c365179bdc6a4e70b64b05903ba59a30b950d0eecae693f6791d9e5.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 4, Criteria: 0.21443737679234914
</pre></div>
</div>
<img alt="_images/119eed3006206fdf10693c734cae2bad7901a2aabbb12bcbe75475a87384f756.png" src="_images/119eed3006206fdf10693c734cae2bad7901a2aabbb12bcbe75475a87384f756.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 5, Criteria: 0.17264469262804974
</pre></div>
</div>
<img alt="_images/9c71a48edb8874f97db9b787ee2e4e5dd4e3602fd57e3ea3685d432c19be7098.png" src="_images/9c71a48edb8874f97db9b787ee2e4e5dd4e3602fd57e3ea3685d432c19be7098.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 6, Criteria: 0.13166046839863524
</pre></div>
</div>
<img alt="_images/adedafd986595d9881467e48648c394b3714a4c7d49d9bfe3c0be3d047d66bbc.png" src="_images/adedafd986595d9881467e48648c394b3714a4c7d49d9bfe3c0be3d047d66bbc.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 7, Criteria: 0.09491426465540308
</pre></div>
</div>
<img alt="_images/fd838a50c514f22ac37cfcac14082520042fda46e0dde4e4c24e5eb38ebbcb93.png" src="_images/fd838a50c514f22ac37cfcac14082520042fda46e0dde4e4c24e5eb38ebbcb93.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 8, Criteria: 0.06510246805138603
</pre></div>
</div>
<img alt="_images/390852cc4a14bd96a7377f4aed7ca7f481bd55fd7e4fca3c9f8acba64a917413.png" src="_images/390852cc4a14bd96a7377f4aed7ca7f481bd55fd7e4fca3c9f8acba64a917413.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 9, Criteria: 0.04319878670547142
</pre></div>
</div>
<img alt="_images/500453d39de6b13a7b105c54d13a0f22776b8fc27058b3d38fc7bd9c795fded6.png" src="_images/500453d39de6b13a7b105c54d13a0f22776b8fc27058b3d38fc7bd9c795fded6.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 10, Criteria: 0.028501096352114078
</pre></div>
</div>
<img alt="_images/900bb15f0b3994737e1cf638fcd05394995844d993271d8dbd888fa6be347e68.png" src="_images/900bb15f0b3994737e1cf638fcd05394995844d993271d8dbd888fa6be347e68.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 11, Criteria: 0.01908014768237006
</pre></div>
</div>
<img alt="_images/d7684643838c775d0fa7096d3f0d8228f34beb194f83892dfab4c3bb756872e1.png" src="_images/d7684643838c775d0fa7096d3f0d8228f34beb194f83892dfab4c3bb756872e1.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 12, Criteria: 0.012944361024599126
</pre></div>
</div>
<img alt="_images/93c56c5cceb345eb79a63babd85e6ac9d04f4b25dc31d378dfd6aa84b6802e80.png" src="_images/93c56c5cceb345eb79a63babd85e6ac9d04f4b25dc31d378dfd6aa84b6802e80.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 13, Criteria: 0.008740422079077206
</pre></div>
</div>
<img alt="_images/6db9a8d19cf85df202f333f1f01d5a4518a20d328cb34c18c86bbd0b11c029b1.png" src="_images/6db9a8d19cf85df202f333f1f01d5a4518a20d328cb34c18c86bbd0b11c029b1.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 14, Criteria: 0.00577778359249276
</pre></div>
</div>
<img alt="_images/f2edd294ceb10cacd7e0294941e4cc60231bcf7a869f5bc51eead7acadb1a68a.png" src="_images/f2edd294ceb10cacd7e0294941e4cc60231bcf7a869f5bc51eead7acadb1a68a.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 15, Criteria: 0.0037422437578762038
</pre></div>
</div>
<img alt="_images/e1e4f722d15bca758b88e7c4cf2c2c883012b795e8dc64ca1a7faaa9dde08158.png" src="_images/e1e4f722d15bca758b88e7c4cf2c2c883012b795e8dc64ca1a7faaa9dde08158.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 16, Criteria: 0.002393868947999754
</pre></div>
</div>
<img alt="_images/1785d2dcb7fca8a388f42a74192b2d394fbd5bef40087bc3338ef6f9854f98c5.png" src="_images/1785d2dcb7fca8a388f42a74192b2d394fbd5bef40087bc3338ef6f9854f98c5.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 17, Criteria: 0.0013629466508553016
</pre></div>
</div>
<img alt="_images/4412b1fe5ffc739a02279a46626ee3f430f7d745d96b1c21789c59a1cb039d75.png" src="_images/4412b1fe5ffc739a02279a46626ee3f430f7d745d96b1c21789c59a1cb039d75.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 18, Criteria: 0.0005693709355462084
</pre></div>
</div>
</div>
</div>
<section id="comparing-coherent-point-drift-cpd-and-iterative-closest-point-icp-algorithms-provides-insights-into-their-respective-strengths-and-weaknesses-in-point-cloud-registration-tasks-cpd-a-probabilistic-framework-excels-in-scenarios-where-point-correspondences-are-ambiguous-or-partial-thanks-to-its-ability-to-model-soft-correspondences-and-account-for-noise-and-outliers-effectively-it-can-handle-non-rigid-transformations-and-deformations-making-it-suitable-for-tasks-involving-complex-shapes-or-objects-undergoing-morphological-changes-however-cpd-may-suffer-from-increased-computational-complexity-especially-with-large-datasets-and-requires-careful-parameter-tuning-for-optimal-performance-on-the-other-hand-icp-is-a-simpler-and-computationally-efficient-method-ideal-for-rigid-transformations-and-scenarios-with-well-defined-point-correspondences-it-converges-quickly-and-is-robust-to-noise-making-it-suitable-for-real-time-applications-or-situations-where-computational-resources-are-limited-nevertheless-icp-s-rigid-assumption-limits-its-applicability-to-non-rigid-transformations-or-scenarios-with-significant-shape-variations-in-summary-while-cpd-offers-versatility-and-robustness-for-challenging-registration-tasks-icp-provides-simplicity-and-efficiency-for-more-straightforward-alignment-problems-the-choice-between-cpd-and-icp-depends-on-the-specific-requirements-of-the-registration-task-including-the-nature-of-the-point-clouds-the-presence-of-noise-or-outliers-and-the-desired-level-of-computational-complexity">
<h3>Comparing Coherent Point Drift (CPD) and Iterative Closest Point (ICP) algorithms provides insights into their respective strengths and weaknesses in point cloud registration tasks. CPD, a probabilistic framework, excels in scenarios where point correspondences are ambiguous or partial, thanks to its ability to model soft correspondences and account for noise and outliers effectively. It can handle non-rigid transformations and deformations, making it suitable for tasks involving complex shapes or objects undergoing morphological changes. However, CPD may suffer from increased computational complexity, especially with large datasets, and requires careful parameter tuning for optimal performance. On the other hand, ICP is a simpler and computationally efficient method, ideal for rigid transformations and scenarios with well-defined point correspondences. It converges quickly and is robust to noise, making it suitable for real-time applications or situations where computational resources are limited. Nevertheless, ICP’s rigid assumption limits its applicability to non-rigid transformations or scenarios with significant shape variations. In summary, while CPD offers versatility and robustness for challenging registration tasks, ICP provides simplicity and efficiency for more straightforward alignment problems. The choice between CPD and ICP depends on the specific requirements of the registration task, including the nature of the point clouds, the presence of noise or outliers, and the desired level of computational complexity.<a class="headerlink" href="#comparing-coherent-point-drift-cpd-and-iterative-closest-point-icp-algorithms-provides-insights-into-their-respective-strengths-and-weaknesses-in-point-cloud-registration-tasks-cpd-a-probabilistic-framework-excels-in-scenarios-where-point-correspondences-are-ambiguous-or-partial-thanks-to-its-ability-to-model-soft-correspondences-and-account-for-noise-and-outliers-effectively-it-can-handle-non-rigid-transformations-and-deformations-making-it-suitable-for-tasks-involving-complex-shapes-or-objects-undergoing-morphological-changes-however-cpd-may-suffer-from-increased-computational-complexity-especially-with-large-datasets-and-requires-careful-parameter-tuning-for-optimal-performance-on-the-other-hand-icp-is-a-simpler-and-computationally-efficient-method-ideal-for-rigid-transformations-and-scenarios-with-well-defined-point-correspondences-it-converges-quickly-and-is-robust-to-noise-making-it-suitable-for-real-time-applications-or-situations-where-computational-resources-are-limited-nevertheless-icp-s-rigid-assumption-limits-its-applicability-to-non-rigid-transformations-or-scenarios-with-significant-shape-variations-in-summary-while-cpd-offers-versatility-and-robustness-for-challenging-registration-tasks-icp-provides-simplicity-and-efficiency-for-more-straightforward-alignment-problems-the-choice-between-cpd-and-icp-depends-on-the-specific-requirements-of-the-registration-task-including-the-nature-of-the-point-clouds-the-presence-of-noise-or-outliers-and-the-desired-level-of-computational-complexity" title="Link to this heading">#</a></h3>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Parth Ganeriwala Comprehensive Breadth Examination</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#point-set-registration">Point Set Registration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-closest-point-icp-algorithm">Iterative Closest Point (ICP) Algorithm</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coherent-point-drift-cpd-algorithm">Coherent Point Drift (CPD) Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#algorithm-overview">Algorithm Overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#expectation-step">Expectation Step</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#maximization-step">Maximization Step</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#point-cloud-registration-with-cpd-example-code">Point Cloud Registration with CPD Example Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#https-siavashk-github-io-2017-05-14-coherent-point-drift">(https://siavashk.github.io/2017/05/14/coherent-point-drift/)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-correspondences">Missing Correspondences</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-mixture-models">Gaussian Mixture Models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gmm-based-registration">GMM-based Registration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Expectation Step</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Maximization Step</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#icp-algorithm">ICP Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-coherent-point-drift-cpd-and-iterative-closest-point-icp-algorithms-provides-insights-into-their-respective-strengths-and-weaknesses-in-point-cloud-registration-tasks-cpd-a-probabilistic-framework-excels-in-scenarios-where-point-correspondences-are-ambiguous-or-partial-thanks-to-its-ability-to-model-soft-correspondences-and-account-for-noise-and-outliers-effectively-it-can-handle-non-rigid-transformations-and-deformations-making-it-suitable-for-tasks-involving-complex-shapes-or-objects-undergoing-morphological-changes-however-cpd-may-suffer-from-increased-computational-complexity-especially-with-large-datasets-and-requires-careful-parameter-tuning-for-optimal-performance-on-the-other-hand-icp-is-a-simpler-and-computationally-efficient-method-ideal-for-rigid-transformations-and-scenarios-with-well-defined-point-correspondences-it-converges-quickly-and-is-robust-to-noise-making-it-suitable-for-real-time-applications-or-situations-where-computational-resources-are-limited-nevertheless-icp-s-rigid-assumption-limits-its-applicability-to-non-rigid-transformations-or-scenarios-with-significant-shape-variations-in-summary-while-cpd-offers-versatility-and-robustness-for-challenging-registration-tasks-icp-provides-simplicity-and-efficiency-for-more-straightforward-alignment-problems-the-choice-between-cpd-and-icp-depends-on-the-specific-requirements-of-the-registration-task-including-the-nature-of-the-point-clouds-the-presence-of-noise-or-outliers-and-the-desired-level-of-computational-complexity">Comparing Coherent Point Drift (CPD) and Iterative Closest Point (ICP) algorithms provides insights into their respective strengths and weaknesses in point cloud registration tasks. CPD, a probabilistic framework, excels in scenarios where point correspondences are ambiguous or partial, thanks to its ability to model soft correspondences and account for noise and outliers effectively. It can handle non-rigid transformations and deformations, making it suitable for tasks involving complex shapes or objects undergoing morphological changes. However, CPD may suffer from increased computational complexity, especially with large datasets, and requires careful parameter tuning for optimal performance. On the other hand, ICP is a simpler and computationally efficient method, ideal for rigid transformations and scenarios with well-defined point correspondences. It converges quickly and is robust to noise, making it suitable for real-time applications or situations where computational resources are limited. Nevertheless, ICP’s rigid assumption limits its applicability to non-rigid transformations or scenarios with significant shape variations. In summary, while CPD offers versatility and robustness for challenging registration tasks, ICP provides simplicity and efficiency for more straightforward alignment problems. The choice between CPD and ICP depends on the specific requirements of the registration task, including the nature of the point clouds, the presence of noise or outliers, and the desired level of computational complexity.</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Parth Ganeriwala
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>